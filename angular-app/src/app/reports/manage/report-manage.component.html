<div class="relative">

  <app-loading-overlay [loading]="loading"></app-loading-overlay>
  <p-toast position="bottom-right"></p-toast>

  <div
    class="w-full flex justify-end pr-20 py-4"
    *ngIf="!showMenu"
  >
    <button
      (click)="
        results.length > 1 && pdfUrl ? revokeUrl()
        : showMenu = true
      "
      type="button"
      class="flex items-center gap-2 px-3 py-2 rounded-lg
         text-sm font-medium
         bg-slate-50 dark:bg-white/5
         text-slate-600 dark:text-slate-300
         hover:bg-slate-100 dark:hover:bg-NG white/10
         transition"
    >

    <span>
      {{ results.length > 1 && pdfUrl ? 'Mostrar dados' : 'Mostrar filtros' }}
    </span>

      <i
        class="pi pi-chevron-down text-xs transition-transform duration-200"
      ></i>
    </button>
  </div>

  <section class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- üîò Seletor Manuten√ß√£o / Instala√ß√£o -->
    <div
      *ngIf="showMenu"
      class="flex justify-center">
      <p-selectButton
        [options]="serviceScopes"
        [(ngModel)]="filters.scope"
        optionLabel="label"
        optionValue="value"
        (onChange)="resetFilters(filters.scope)">
      </p-selectButton>
    </div>


    <!-- üéõÔ∏è Filtros -->
    <section
      *ngIf="showMenu"
      class="rounded-2xl border border-slate-200 dark:border-white/10
         bg-white dark:bg-slate-900 shadow-sm">

      <!-- Header -->
      <div class="px-6 py-4 border-b border-slate-200 dark:border-white/10">
        <h2 class="text-base font-semibold text-slate-900 dark:text-slate-100">
          Filtros
        </h2>
        <p class="text-sm text-slate-500 dark:text-slate-400">
          Refine os resultados por contrato, per√≠odo e tipo de servi√ßo
        </p>
      </div>

      <!-- Campos -->
      <div class="p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-5">

        <!-- Contrato / Cidade -->
        <div class="flex flex-col gap-1">
          <label class="text-xs font-medium text-slate-600 dark:text-slate-400">
            Contrato
          </label>
          <p-dropdown
            [options]="filteredContracts"
            optionValue="contractId"
            optionLabel="contractor"
            [(ngModel)]="filters.contractId"
            placeholder="Contrato"
            [showClear]="true"
            [filter]="true"
            filterPlaceholder="Buscar contrato">

            <!-- Item selecionado (compacto) -->
            <ng-template pTemplate="selectedItem" let-item>
              <span
                class="block max-w-full truncate text-sm"
                [title]="item?.contractor">
                {{ Utils.abbreviate(item?.contractor) }}
              </span>
            </ng-template>

            <!-- Lista (nome completo) -->
            <ng-template pTemplate="item" let-item>
              <div class="flex flex-col">
                <span class="font-medium text-sm">{{ item.contractor }}</span>
                <span class="text-xs text-slate-500">
                  Contrato N¬∫ {{ item.contractNumber }}
                </span>
              </div>
            </ng-template>

          </p-dropdown>


          <p-message severity="error" styleClass="mt-1" *ngIf="!filters.contractId && submitted">Filtro obrigat√≥rio
          </p-message>
        </div>

        <!-- Tipo de servi√ßo -->
        <div class="flex flex-col gap-1">
          <label class="text-xs font-medium text-slate-600 dark:text-slate-400">
            Tipo de servi√ßo
          </label>
          <p-dropdown
            [options]="serviceTypes[filters.scope]"
            optionLabel="label"
            optionValue="value"
            [(ngModel)]="filters.type"
            placeholder="Selecione o tipo"
            class="w-full">
          </p-dropdown>

          <p-message severity="error" styleClass="mt-1" *ngIf="!filters.type && submitted">Filtro obrigat√≥rio
          </p-message>
        </div>

        <!-- Data inicial -->
        <div class="flex flex-col gap-1">
          <label class="text-xs font-medium text-slate-600 dark:text-slate-400">
            Data inicial
          </label>
          <p-calendar
            [(ngModel)]="filters.startDate"
            placeholder="dd/mm/aaaa"
            dateFormat="dd/mm/yy"
            fluid
            class="w-full">
          </p-calendar>

          <p-message severity="error" styleClass="mt-1" *ngIf="!filters.startDate && submitted">Filtro obrigat√≥rio
          </p-message>
        </div>

        <!-- Data final -->
        <div class="flex flex-col gap-1">
          <label class="text-xs font-medium text-slate-600 dark:text-slate-400">
            Data final
          </label>
          <p-calendar
            [(ngModel)]="filters.endDate"
            placeholder="dd/mm/aaaa"
            dateFormat="dd/mm/yy"
            fluid
            class="w-full">
          </p-calendar>

          <p-message severity="error" styleClass="mt-1" *ngIf="!filters.endDate && submitted">Filtro obrigat√≥rio
          </p-message>
        </div>

        <!-- Modo de visualiza√ß√£o -->
        <div class="flex flex-col gap-1">
          <label class="text-xs font-medium text-slate-600 dark:text-slate-400">
            Visualiza√ß√£o
          </label>
          <p-dropdown
            [options]="viewModes"
            [(ngModel)]="filters.viewMode"
            optionLabel="label"
            optionValue="value"
            placeholder="Modo de retorno"
            class="w-full">
          </p-dropdown>
        </div>

      </div>

      <!-- A√ß√µes -->
      <div
        class="px-6 py-4 flex flex-col sm:flex-row justify-end gap-3
           border-t border-slate-200 dark:border-white/10">

        <button
          class="px-4 py-2 rounded-lg border text-sm
             border-slate-300 dark:border-white/20
             text-slate-600 dark:text-slate-300
             hover:bg-slate-50 dark:hover:bg-white/5"
          (click)="resetFilters(filters.scope)">
          Limpar filtros
        </button>

        <button
          (click)="applyFilters()"
          class="px-5 py-2 rounded-lg bg-blue-600 text-white text-sm
             hover:bg-blue-700 transition">
          Aplicar filtros
        </button>

      </div>

    </section>


    <!-- üìä Resultados -->
    <div *ngIf="!showMenu"
         class="flex flex-col items-center gap-1 px-3 py-2">

      <!-- Nome do contrato -->
      <h2
        class="text-center text-base sm:text-lg font-semibold text-slate-800 dark:text-slate-100 leading-tight">
        {{ Utils.abbreviate(results[0].contract.contractor) }}
      </h2>

      <!-- N√∫mero do contrato -->
      <p
        class="text-center text-xs sm:text-sm text-slate-500 dark:text-slate-400">
        Contrato n¬∫ <span class="font-medium text-slate-700 dark:text-slate-300">
      {{ getContractNumber() }}
    </span>
      </p>

      <!-- Tipo -->
      <span
        class="mt-1 inline-flex items-center rounded-md bg-slate-100 px-2 py-0.5
           text-xs font-medium text-slate-600
           dark:bg-slate-800 dark:text-slate-300">
    {{ getType() }}
  </span>

    </div>

    <div class="w-full h-[100svh] overflow-hidden bg-slate-100 dark:bg-slate-900" *ngIf="!showMenu && pdfUrl">
      <iframe
        [src]="pdfUrl | safeUrl"
        class="w-full h-full rounded-none"
      ></iframe>

      <!-- Bot√£o flutuante -->
      <button
        (click)="sharePdf()"
        class="
                fixed bottom-4 right-4 z-50
                flex items-center gap-2
                px-4 py-3 rounded-full

                backdrop-blur-md

                bg-white/70 dark:bg-slate-800/70
                border border-black/5 dark:border-white/10

                shadow-[0_8px_24px_rgba(0,0,0,0.12)]
                dark:shadow-[0_8px_24px_rgba(0,0,0,0.4)]

                active:scale-95 transition

                text-slate-800 dark:text-slate-100
              ">

        @if (isApple) {
          <span class="material-icons">ios_share</span>
        } @else if (isAndroid) {
          <span class="material-icons">share</span>
        } @else () {
          <span class="material-icons">download</span>
        }

        {{ isAndroid || isApple ? 'Compartilhar' : 'Baixar PDF' }}
      </button>
    </div>

    <div
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
      *ngIf="!showMenu && !pdfUrl">

      <ng-container *ngFor="let rs of results">
        <div
          *ngFor="let r of rs.executions"
          (click)="generateIndividualPdf(r.execution_id, r.execution_type)"
          class="relative flex flex-col gap-3
           rounded-2xl border border-slate-200 bg-white p-5 shadow-sm
           dark:border-white/10 dark:bg-slate-900 cursor-pointer">

          <!-- Header -->
          <div class="flex items-center justify-between">
            <p class="text-sm font-medium text-slate-700 dark:text-slate-200">
              Data da execu√ß√£o: {{ r.date_of_visit | date:'dd/MM/yyyy' }}
            </p>
          </div>

          <!-- M√©tricas principais -->
          <div class="grid grid-cols-2 gap-3 pt-1">

            <div class="flex flex-col">
        <span class="text-xs text-slate-500 dark:text-slate-400">
          Pontos atendidos
        </span>
              <span class="text-lg font-semibold text-slate-900 dark:text-white">
          {{ r.streets.length }}
        </span>
            </div>

            <div class="flex flex-col">
        <span class="text-xs text-slate-500 dark:text-slate-400">
          Tempo m√©dio
        </span>
              <span class="text-lg font-semibold text-slate-900 dark:text-white">
          {{ Utils.diffInHours(r.date_of_visit, r.finished_at) }}h
        </span>
            </div>

          </div>

          <!-- Time -->
          <div class="pt-2">
      <span class="block text-xs text-slate-500 dark:text-slate-400 mb-1">
        Equipe executora
      </span>

            <div class="flex flex-wrap gap-1.5">
        <span
          *ngFor="let t of r.team"
          class="inline-flex items-center rounded-md
                 bg-slate-100 px-2 py-0.5 text-xs
                 font-medium text-slate-700
                 dark:bg-slate-800 dark:text-slate-300">
          {{ t.name }} {{ t.last_name }}
          <span class="ml-1 text-slate-400 dark:text-slate-500">
            ‚Ä¢ {{ t.role }}
          </span>
        </span>
            </div>
          </div>

        </div>
      </ng-container>

    </div>


  </section>

</div>
