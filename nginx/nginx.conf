events {}

http {
    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_min_length 1024;
    gzip_types 
        application/json
        application/javascript
        text/css
        text/html
        text/plain
        text/xml
        application/xml
        image/svg+xml;

    # Cabeçalhos de segurança
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Frame-Options "SAMEORIGIN";
    add_header Referrer-Policy "no-referrer-when-downgrade";    

    # Limitação de requisições e conexões
    limit_req_zone $binary_remote_addr zone=botlimit:10m rate=5r/s;
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    client_max_body_size 200M;

    # Bloco compartilhado para verificações comuns de segurança (User-Agent, Host, Bot)
    map $http_user_agent $blocked {
        default         0;
        ""              1;
        "~*Bot|Crawler|Spammer|Scraper" 1;
    }

    map $host $blocked_host {
        default         1;
        "spring.thryon.com.br" 0;
        "minio-console.thryon.com.br" 0;
        "api.thryon.com.br" 0;
    }

    server {
        listen 80;
        server_name api.thryon.com.br;  # Domínio

        # Verifica se o host é permitido e se o user agent é bloqueado
        if ($blocked_host) {
            return 403;
        }

        if ($blocked) {
            return 403;
        }

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Authorization $http_authorization;

        # Restante do código de localização
        location /spring/ {
            limit_req zone=botlimit burst=10 nodelay;
            limit_conn addr 10;

            proxy_pass http://springboot-app:8080/;
        }

        location /minio/ {
            limit_req zone=botlimit burst=10 nodelay;
            limit_conn addr 10;

            proxy_pass http://minio:9000/;
        }
    }


    server {
        listen 80;
        server_name spring.thryon.com.br;  # Domínio

        location / {
            limit_req zone=botlimit burst=10 nodelay;
            limit_conn addr 10;

            # Verifica se o host é o correto
            if ($blocked_host) {
                return 403;
            }

            # Verifica se o User-Agent é vazio ou é um bot
            if ($blocked) {
                return 403;
            }

            # Cabeçalhos para proxy
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Authorization $http_authorization;

            # Proxy pass para o Spring Boot (contêiner ou servidor)
            proxy_pass http://springboot-app:8080;  # Backend Spring Boot
        }
    }

    server {
        listen 80;
        server_name minio-console.thryon.com.br;

        location / {
            limit_req zone=botlimit burst=10 nodelay;
            limit_conn addr 10;

            if ($blocked_host) {
                return 403;
            }

            if ($blocked) {
                return 403;
            }

            proxy_pass http://minio:9090;  # Console MinIO contêiner

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_http_version 1.1;
            # Caso precise de websocket (ajuste conforme sua necessidade)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

}